\chapter{\acl{mipwa}}
\label{chap:model_independent_pwa}

    \section{What I have developed}

    \section{Tests of model-independent partial-wave analysis}
    \ac{mipwa} allows for a description of waves whose resonance content is not yet well known or whose resonance shapes are not yet precisely understood.
    As an example, \citeauthor{PhysRevD.73.032004}~\cite{PhysRevD.73.032004} already employed \ac{mipwa} in the measurement of S-wave amplitudes for $\PDplus\to\PKminus\Ppiplus\Ppiplus$ decays at Fermilab.
    \citeauthor{Link200914}~\cite{Link200914} for the {\small FOCUS} collaboration also conducted a similar study on the same hadronic decay.


    As of writing, \pac{yap} does yet not allow for a proper handling of \ac{mipwa} fits.
    I implemented a \ac{mipwa} by adding a new dynamic shape that is indeed a characteristic function on a right-open range mass $M = [m_\textup{min}, m_\textup{max})$, which means:
    \begin{equation}
        B_M(m) = 
        \begin{cases}
            1 &\text{if }m\in M, \\
            0 &\text{otherwise}.
        \end{cases}
    \end{equation}
    The mass range of the Dalitz plot is then partitioned in $N_\text{bins}$ number of bins and $N_\text{bins}$ artificial decaying particles with characteristic functions as dynamic shapes are added to the \lstinline!DecayChannel!.
    Each of this particles adds a complex parameter to the fit so that, in total, $N_\text{bins}$ free real amplitude pairs $(\rho_i,\phi_i)$ need to be fitted.


    To test this approach I have fitted (what?) to a data set generated by a \pac{bat}'s \ac{mc} engine.
    In the figure~\ref{fig:mi_test_data} I simulated a $\PDplus\to\Ppiplus\Ppiminus\Ppiplus$ decay with only one resonance, namely $\Pfz\to\Ppiplus\Ppiminus$.
    The specific resonance I have chosen is not important here, I only chose it because it's spinless.
    In the plot, I have set its width to \SI{280}{\mega\electronvolt}, which is four times the particle's width value, to have enough events in all the bins and agevolate the fit.


    In the figure~\ref{fig:mi_test_fit_amp_8bins} I performed a fit by partitioning the mass range in eight equally-wide bins.
    The Breit-Wigner structure is reproduced.




    In the first fit attempt, I represented the complex fit parameters with their real and imaginary parts.
    With this choice, the pre-run did not converge as there is an ambiguity in the sign of the imaginary part of the parameters.
    In fatc, for each set of parameters $\Set{(\Re,\Im)_i}$ that maximizes the likelihood, also $\Set{(\Re,-\Im)_i}$ does.


    When representing the fit parameters in terms of magnitude and fase, the ambiguity remains.
    Moreover, \pac{bat} cannot properly handle the phase periodicity so the phase-space sampling becomes inefficient.
    To get rid of the sign ambiguity in the phase, I have chosen the fit parameters to be the magnitude of the bin free amplitudes and the phase difference between each bin's free amplidude and the previous bin's one.
    Namely the fit parameters are $P_i = (\rho_i, \uD\phi_i)$, where $\rho_i$ is the free-amplitude magnitude of the $i$-th bin, $\abs{A_i}$, and $\uD\phi_i = \phi_i - \phi_{i-1}$ is the difference between two adjacent bin's free-amplitude phases. 
    The phase ambiguity is removed by enforcing each fit parameter $\uD\phi_i$ to be non-negative.
    Note that by convention the first phase difference is set to zero:
    \begin{equation}\label{eq:delta_phi_zero_cond}
        \uD\phi_0 \coloneqq 0.
    \end{equation}

    During the fit I have noticed that the convergence takes longer for the phase-difference parameters than for the magnitude parameters to be reached.

    \subsection{Fit runtime}


    \begin{figure}
        \centering
        \begin{tikzpicture}
            \begin{semilogyaxis} [
                    xlabel = {Number of bins},
                    ylabel = {Runtime [\si{\hour}]}
                ]
                \addplot+ table {data/time_scale.dat};
            \end{semilogyaxis}
        \end{tikzpicture}
        \caption{Fit runtimes as a function of the number of bins in the allowed mass range.}
        \label{fig:time_scale}
    \end{figure}

    The figure~\ref{fig:time_scale} shows the time scaling of the fit with the number of bins.
    The rumtime increases exponentially when the number of bins grows.
    Note that each bin adds two real \acp{dof} to the fit so that
    \begin{equation}
        N_\text{DOF} = 2(N_\text{bins} - 1).
    \end{equation}
    One of the \acp{dof} is always fixed by the condition~\eqref{eq:delta_phi_zero_cond}.
    \begin{figure}
        \centering
        \input{fig/output8bins/parameters.pgf}
        \caption{Breit-Wigner fitted with eight equally-spaced bins using \pac{bat}.
                 The secont bin's free amplitude magnitude is fixed to \num{1}.}
        \label{fig:mi_test_fit_amp_8bins}
    \end{figure}
    I usually fix the other \ac{dof} by setting the magnitude of some free amplitude to \num{1}, \eg{}~in figure~\ref{fig:mi_test_fit_amp_8bins} I fixed the second bin's free amplitude.


\begin{figure}
    \centering
    %\includegraphics[width=.9\textwidth]{fig/toy_example.pdf}
    \caption{\ac{mc}-generated data set for testing the \ac{mipwa} approach in \pac{yap}.}
    \label{fig:mi_test_data}
\end{figure}

    \subsection{Pre-run exceptions}

    {\color{red} Why?
    To fit a model to some data, a pre-run must be done(?).
    }

    I noticed that \pac{bat} crashed in the pre-run phase if I tried to generate initial point when the mass-width of the bins was \SI{45.3}{\mega\electronvolt}.

    Generating initial points works with a bin width of \SI{60.5}{\mega\electronvolt} but fails with \SI{45.3}{\mega\electronvolt}.
    Can this maybe depend on the number of parameters?

    \begin{lstlisting}
terminate called after throwing an instance of 'std::runtime_error'
  what():  BCEngineMCMC::MCMCInitialize : Could not generate uniformly distributed initial point with valid probability in 10000000 tries.
  zsh: abort (core dumped)  ./runBatFit
    \end{lstlisting}


    \begin{figure}
        \centering

        \subfloat[][\label{fig:f0_phase_fit}]{\input{fig/f0_f2/s_phase.pgf}}

        \subfloat[][]{\input{fig/f0_f2/s_decay_amplitude.pgf}}

        \caption{Freed-wave fit of the S wave of a $\PDplus \to \Ppiplus\Ppiminus\Ppiplus$ decay through the \Pfnez{} resonance.} 
        \label{fig:f0_fit}
    \end{figure}

    \begin{figure}
        \centering

        \subfloat[][Here the effect of the non-negative phase motion is visible. Due to a misidentification of the second phase value, the phases up to \SI{1}{\giga\electronvolt} are systematically shifted up.]{\input{fig/f0_f2/d_phase.pgf}}

        \subfloat[][In the end of the phase space, the angular dependency becomes small. This introduces an ambiguity in the phase also.]{\input{fig/f0_f2/d_decay_amplitude.pgf}}

        \caption{Freed-wave fit of the D wave of a $\PDplus \to \Ppiplus\Ppiminus\Ppiplus$ decay through the \Pfii{} resonance.}
    \end{figure}

    \begin{figure}
        \centering
        \subfloat[][Source data: decay in the S and D wave through the \Pfnez{} and \Pfii{} resonances.]{\input{fig/f0_f2/dalitz.pgf}}

        \subfloat[][Result of the model-independent fit to the plot shown above.]{\input{fig/f0_f2/dalitz_fit.pgf}}
        \caption{\ac{mc}-generated Dalitz plots of a $\PDplus \to \Ppiplus\Ppiminus\Ppiplus$ decay.}
    \end{figure}


    \begin{figure}
        \centering

        \subfloat[][Unlike the phase fit~\ref{fig:f0_phase_fit}, to perform this fit, I had to allow the negative values for the phase motion.]{\input{fig/f0_f0-1500/phase.pgf}}

        \subfloat[][Sum of two Breit-Wigner mass shapes with zero relative phase.]{\input{fig/f0_f0-1500/decay_amplitude.pgf}}

        \caption{Freed-wave fit of the S wave of a $\PDplus \to \Ppiplus\Ppiminus\Ppiplus$ decay through the \Pfnez{} and \Pfofzz{} resonances.}
    \end{figure}

    \begin{figure}
        \centering
        \subfloat[][Source data: S-wave decay through the \Pfnez{} and \Pfofzz{} resonances.]{\input{fig/f0_f0-1500/dalitz.pgf}}

        \subfloat[][Result of the model-independent fit to the plot shown above.]{\input{fig/f0_f0-1500/dalitz_fit.pgf}}

        \caption{\ac{mc}-generated Dalitz plots of a $\PDplus \to \Ppiplus\Ppiminus\Ppiplus$ decay.}
    \end{figure}

    \begin{figure}
        \centering

        \subfloat[][]{\input{fig/rho0/phase.pgf}}

        \subfloat[][]{\input{fig/rho0/decay_amplitude.pgf}}


        \caption{Freed-wave fit of the P wave of a $\PDplus \to \Ppiplus\Ppiminus\Ppiplus$ decay through the \Prhozero{} resonance.}
    \end{figure}

    \begin{figure}
        \centering
        \subfloat[\acs{mc}-generated Dalitz plot of a P-wave decay through the \Prhozero{} resonance.]%
                 [Source data: P-wave decay through the \Prhozero{} resonance.]%
                 {\input{fig/rho0/dalitz.pgf}}

        \subfloat[\acs{mc}-generated Dalitz plot of a P-wave decay through the \Prhozero{} resonance.]%
                 [Result of the model-independent fit to the plot shown above.]%
                 {\input{fig/rho0/dalitz_fit.pgf}}

        \caption{\ac{mc}-generated Dalitz plots of a P-wave $\PDplus \to \Ppiplus\Ppiminus\Ppiplus$ decay through the \Prhozero{} resonance.}

    \end{figure}

    \begin{figure}
        \centering

        \subfloat[][]{\input{fig/f2/phase.pgf}}

        \subfloat[][\label{fig:f2_amplitude}]{\input{fig/f2/decay_amplitude.pgf}}


        \caption{Freed-wave fit of the D wave of a $\PDplus \to \Ppiplus\Ppiminus\Ppiplus$ decay through the \Pfii{} resonance.}
    \end{figure}

    \begin{figure}
        \centering
        \subfloat[]%
                 [Source data: D-wave decay through the \Pfii{} resonance.\label{fig:f2_dalitz_source}]%
                 {\input{fig/f2/dalitz.pgf}}

        \subfloat[]%
                 [Result of the model-independent fit to the plot shown above.]%
                 {\input{fig/f2/dalitz_fit.pgf}}

        \caption{\ac{mc}-generated Dalitz plots of a $\PDplus \to \Ppiplus\Ppiminus\Ppiplus$ decay.}

    \end{figure}

    The determination of the phase motion is much easier for the S wave than it is for other waves, due to their non-trivial angular dependency.
    \begin{figure}
        \centering
        \input{fig/f2/phase_diff.pgf}
        \caption{Phase motion of the \Pfii{} fit. The phase motion of the first bin is fized to zero.}
        \label{fig:fit_f2_phase_motion}
    \end{figure}
    The figure~\ref{fig:fit_f2_phase_motion} shows a comparison between the fitted phase phase motion for the \Pfii{} resonance in the Dalitz plot~\ref{fig:f2_dalitz_source}. 
    The last two phase motions are not precisely determined due to the effect of the wave angular dependency, which tends to suppress the decay amplitude at the end of the phase space. 
    The decay-amplitude dumping makes the fit ambiguous in that area of the Dalitz plot.
    This effect can also be seen in the amplitude plot~\ref{fig:f2_amplitude}.


    The same holds for the P-wave \Prhozero{} fit.


    \include{mainmatter/fit_likelihood}

